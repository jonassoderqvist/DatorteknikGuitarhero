#include <pic32mx.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>


#define DISPLAY_VDD PORTFbits.RF6
#define DISPLAY_VBATT PORTFbits.RF5
#define DISPLAY_COMMAND_DATA PORTFbits.RF4
#define DISPLAY_RESET PORTGbits.RG9


#define DISPLAY_VDD_PORT PORTF
#define DISPLAY_VDD_MASK 0x40
#define DISPLAY_VBATT_PORT PORTF
#define DISPLAY_VBATT_MASK 0x20
#define DISPLAY_COMMAND_DATA_PORT PORTF
#define DISPLAY_COMMAND_DATA_MASK 0x10
#define DISPLAY_RESET_PORT PORTG
#define DISPLAY_RESET_MASK 0x200

static const uint8_t const font[] = {
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 0, 0, 0, 0, 0,
	0, 0, 0, 94, 0, 0, 0, 0,
	0, 0, 4, 3, 4, 3, 0, 0,
	0, 36, 126, 36, 36, 126, 36, 0,
	0, 36, 74, 255, 82, 36, 0, 0,
	0, 70, 38, 16, 8, 100, 98, 0,
	0, 52, 74, 74, 52, 32, 80, 0,
	0, 0, 0, 4, 3, 0, 0, 0,
	0, 0, 0, 126, 129, 0, 0, 0,
	0, 0, 0, 129, 126, 0, 0, 0,
	0, 42, 28, 62, 28, 42, 0, 0,
	0, 8, 8, 62, 8, 8, 0, 0,
	0, 0, 0, 128, 96, 0, 0, 0,
	0, 8, 8, 8, 8, 8, 0, 0,
	0, 0, 0, 0, 96, 0, 0, 0,
	0, 64, 32, 16, 8, 4, 2, 0,
	0, 62, 65, 73, 65, 62, 0, 0,
	0, 0, 66, 127, 64, 0, 0, 0,
	0, 0, 98, 81, 73, 70, 0, 0,
	0, 0, 34, 73, 73, 54, 0, 0,
	0, 0, 14, 8, 127, 8, 0, 0,
	0, 0, 35, 69, 69, 57, 0, 0,
	0, 0, 62, 73, 73, 50, 0, 0,
	0, 0, 1, 97, 25, 7, 0, 0,
	0, 0, 54, 73, 73, 54, 0, 0,
	0, 0, 6, 9, 9, 126, 0, 0,
	0, 0, 0, 102, 0, 0, 0, 0,
	0, 0, 128, 102, 0, 0, 0, 0,
	0, 0, 8, 20, 34, 65, 0, 0,
	0, 0, 20, 20, 20, 20, 0, 0,
	0, 0, 65, 34, 20, 8, 0, 0,
	0, 2, 1, 81, 9, 6, 0, 0,
	0, 28, 34, 89, 89, 82, 12, 0,
	0, 0, 126, 9, 9, 126, 0, 0,
	0, 0, 127, 73, 73, 54, 0, 0,
	0, 0, 62, 65, 65, 34, 0, 0,
	0, 0, 127, 65, 65, 62, 0, 0,
	0, 0, 127, 73, 73, 65, 0, 0,
	0, 0, 127, 9, 9, 1, 0, 0,
	0, 0, 62, 65, 81, 50, 0, 0,
	0, 0, 127, 8, 8, 127, 0, 0,
	0, 0, 65, 127, 65, 0, 0, 0,
	0, 0, 32, 64, 64, 63, 0, 0,
	0, 0, 127, 8, 20, 99, 0, 0,
	0, 0, 127, 64, 64, 64, 0, 0,
	0, 127, 2, 4, 2, 127, 0, 0,
	0, 127, 6, 8, 48, 127, 0, 0,
	0, 0, 62, 65, 65, 62, 0, 0,
	0, 0, 127, 9, 9, 6, 0, 0,
	0, 0, 62, 65, 97, 126, 64, 0,
	0, 0, 127, 9, 9, 118, 0, 0,
	0, 0, 38, 73, 73, 50, 0, 0,
	0, 1, 1, 127, 1, 1, 0, 0,
	0, 0, 63, 64, 64, 63, 0, 0,
	0, 31, 32, 64, 32, 31, 0, 0,
	0, 63, 64, 48, 64, 63, 0, 0,
	0, 0, 119, 8, 8, 119, 0, 0,
	0, 3, 4, 120, 4, 3, 0, 0,
	0, 0, 113, 73, 73, 71, 0, 0,
	0, 0, 127, 65, 65, 0, 0, 0,
	0, 2, 4, 8, 16, 32, 64, 0,
	0, 0, 0, 65, 65, 127, 0, 0,
	0, 4, 2, 1, 2, 4, 0, 0,
	0, 64, 64, 64, 64, 64, 64, 0,
	0, 0, 1, 2, 4, 0, 0, 0,
	0, 0, 48, 72, 40, 120, 0, 0,
	0, 0, 127, 72, 72, 48, 0, 0,
	0, 0, 48, 72, 72, 0, 0, 0,
	0, 0, 48, 72, 72, 127, 0, 0,
	0, 0, 48, 88, 88, 16, 0, 0,
	0, 0, 126, 9, 1, 2, 0, 0,
	0, 0, 80, 152, 152, 112, 0, 0,
	0, 0, 127, 8, 8, 112, 0, 0,
	0, 0, 0, 122, 0, 0, 0, 0,
	0, 0, 64, 128, 128, 122, 0, 0,
	0, 0, 127, 16, 40, 72, 0, 0,
	0, 0, 0, 127, 0, 0, 0, 0,
	0, 120, 8, 16, 8, 112, 0, 0,
	0, 0, 120, 8, 8, 112, 0, 0,
	0, 0, 48, 72, 72, 48, 0, 0,
	0, 0, 248, 40, 40, 16, 0, 0,
	0, 0, 16, 40, 40, 248, 0, 0,
	0, 0, 112, 8, 8, 16, 0, 0,
	0, 0, 72, 84, 84, 36, 0, 0,
	0, 0, 8, 60, 72, 32, 0, 0,
	0, 0, 56, 64, 32, 120, 0, 0,
	0, 0, 56, 64, 56, 0, 0, 0,
	0, 56, 64, 32, 64, 56, 0, 0,
	0, 0, 72, 48, 48, 72, 0, 0,
	0, 0, 24, 160, 160, 120, 0, 0,
	0, 0, 100, 84, 84, 76, 0, 0,
	0, 0, 8, 28, 34, 65, 0, 0,
	0, 0, 0, 126, 0, 0, 0, 0,
	0, 0, 65, 34, 28, 8, 0, 0,
	0, 0, 4, 2, 4, 2, 0, 0,
	0, 120, 68, 66, 68, 120, 0, 0,
};

const uint8_t const icon2[] = {
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,240,240,240,
	240,240,240,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
    
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,255,255,255,
	255,255,255,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
    
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,255,255,255,
	255,255,255,0,0,0,0,0,
	0,0,0,0,0,0,0,0,
    
	0,0,0,0,0,0,0,0,
	0,0,0,0,0,15,15,15,
	15,15,15,0,0,0,0,0,
	0,0,0,0,0,0,0,0
};


char textbuffer[4][16];

extern void _enable_interrupt();
int note;
int note2;
int score;

int hiScore[4] = {0,0,0,0}; // fourth element is joker-element, for comparison purposes.


int song1[] = {1,3,0,5,0,3,1,4,2,1,3,0,5,0,3,1,4,2,1,3,0,5,0,3,1,4,2,1,3,0,5,0,3,1,4,2,1,3,0,5,0,3,1,4,2,1,3,0,5}; // hard
int song2[] = {1,2,1,8,4,1,8,2,4,1,8,1,2,4,8,2,8,1,2,8,1,2,1,8,4,8,2,1,4,2,1,8,4,1,4,2,1,8,2,4,1,8,1,4,2,1,8,1,2}; // medium
int song3[] = {1,1,2,2,4,4,8,8,2,2,8,8,4,4,2,2,8,8,2,2,8,8,2,2,1,1,8,8,4,4,2,2,1,1,8,8,4,4,8,8,2,2,1,1,8,8,2,2,1}; // easy

void show_block(int pos);

void setPwm(int pwm, int duty){
	OC1RS = duty;
	PR2 = pwm;
}


void delay(int cyc) {
	int i;
	for(i = cyc; i > 0; i--);
}


int gameInit(int song[50], int dlay) {
		score = 0;
		int btns = getBtns();
    int i = 0;
    for(i < 49; i++;){
			show_block(song[i]);
			delay(dlay);
			
			if((btns & song[i]) == song[i]){
				score++;
			} 
		}
		
		return score;
}

void runGame(int song[50], int speed) {
    score = 0;
    int x=0;
    int i = 0;
    int j=0;
    for(;;) {
        note = song[x];
        note2 = note << 5;
        if(i==(1000000/speed)){
            show_block(note);
            x++;
            if(x==50){
                break;
            }
            i=0;
        }
        i++;
		int btns = getBtns();
		// Check buttons. If button is pressed, corresponding note's play-value will be set to 1 (true)
		if((PORTD & 0b000011100000) == note2){
                if(note!=0){
                   // addScore(j);
                }
        }
    }
}

int getBtns(void) {
 	return((PORTD >>5) &0x7);	/* Port D bits 5 through 8 is used for the Buttons and is set to 1 (input) */
 }

int getbtn(void) {
 	return(PORTD &0x1);
}


void initPwm(){
	T2CON = 0x070; // Clear timer2, prescale at 1:1
	TMR2 = 0x0; // Timer2 value starts at 0
	OC1CON = 0x0000; // Turn off and clear pwm
	OC1R = 0x0001;
	OC1RS = 0; // Dutycycle
	OC1CON = 0x0006; // Configure for PWM mode without Fault pin
	PR2 = 0;
	IECSET(0) = 0x0100; // Enable T2 interrupt
	IPCSET(2) = 0x01C; // Set T2 interrupt priority to 7
	enable_interrupt();
	OC1CONSET = 0x08000; // Enable OC1
	// Om något knasar, titta lite djupare på OC1CONSET!!!
	T2CONSET |= 0x08000; // Enable Timer2
}




// CODE BELOW IS FOR DISPLAY PURPOSES!

uint8_t spi_send_recv(uint8_t data) {
	while(!(SPI2STAT & 0x08));
	SPI2BUF = data;
	while(!(SPI2STAT & 0x01));
	return SPI2BUF;
}

void display_init() {
	DISPLAY_COMMAND_DATA_PORT &= ~DISPLAY_COMMAND_DATA_MASK;
	delay(10);
	DISPLAY_VDD_PORT &= ~DISPLAY_VDD_MASK;
	delay(1000000);
	
	spi_send_recv(0xAE);
	DISPLAY_RESET_PORT &= ~DISPLAY_RESET_MASK;
	delay(10);
	DISPLAY_RESET_PORT |= DISPLAY_RESET_MASK;
	delay(10);
	
	spi_send_recv(0x8D);
	spi_send_recv(0x14);
	
	spi_send_recv(0xD9);
	spi_send_recv(0xF1);
	
	DISPLAY_VBATT_PORT &= ~DISPLAY_VBATT_MASK;
	delay(10000000);
	
	spi_send_recv(0xA1);
	spi_send_recv(0xC8);
	
	spi_send_recv(0xDA);
	spi_send_recv(0x20);
	
	spi_send_recv(0xAF);
}

void display_string(int line, char *s) {
	int i;
	if(line < 0 || line >= 4)
		return;
	if(!s)
		return;
	
	for(i = 0; i < 16; i++)
		if(*s) {
			textbuffer[line][i] = *s;
			s++;
		} else
			textbuffer[line][i] = ' ';
}

void display_image(int x, const uint8_t *data) {
	int i, j;
	
	for(i = 0; i < 4; i++) {
		DISPLAY_COMMAND_DATA_PORT &= ~DISPLAY_COMMAND_DATA_MASK;
		spi_send_recv(0x22);
		spi_send_recv(i);
		
		spi_send_recv(x & 0xF);
		spi_send_recv(0x10 | ((x >> 4) & 0xF));
		
		DISPLAY_COMMAND_DATA_PORT |= DISPLAY_COMMAND_DATA_MASK;
		
		for(j = 0; j < 32; j++)
			spi_send_recv(~data[i*32 + j]);
	}
}

void display_update() {
	int i, j, k;
	int c;
	for(i = 0; i < 4; i++) {
		DISPLAY_COMMAND_DATA_PORT &= ~DISPLAY_COMMAND_DATA_MASK;
		spi_send_recv(0x22);
		spi_send_recv(i);
		
		spi_send_recv(0x0);
		spi_send_recv(0x10);
		
		DISPLAY_COMMAND_DATA_PORT |= DISPLAY_COMMAND_DATA_MASK;
		
		for(j = 0; j < 16; j++) {
			c = textbuffer[i][j];
			if(c & 0x80)
				continue;
			
			for(k = 0; k < 8; k++)
				spi_send_recv(font[c*8 + k]);
		}
	}
}


void show_block(int pos) {
	display_update();
	switch(pos){
		case 0: 
			break;
		case 1: 
			display_image(100, icon2);
			break;
		case 2:
			display_image(50, icon2);
			break;
		case 3:
			display_image(50, icon2);
			display_image(100, icon2);
			break;
		case 4:
			display_image(0, icon2);
			break;
		case 5:
			display_image(0, icon2);
			display_image(100, icon2);
			break;
		case 6:
			display_image(0, icon2);
			display_image(50, icon2);
			break;	
	}		
}
display_initiate(){
	/* Set up peripheral bus clock */
	OSCCON &= ~0x180000;
	OSCCON |= 0x080000;
	
	/* Set up output pins */
	AD1PCFG = 0xFFFF;
	ODCE = 0x0;
	TRISECLR = 0xFF;
	PORTE = 0x0;
	
	/* Output pins for display signals */
	PORTF = 0xFFFF;
	PORTG = (1 << 9);
	ODCF = 0x0;
	ODCG = 0x0;
	TRISFCLR = 0x70;
	TRISGCLR = 0x200;
	
	/* Set up input pins */
	TRISDSET = (1 << 8);
	TRISFSET = (1 << 1);
	
	/* Set up SPI as master */
	SPI2CON = 0;
	SPI2BRG = 4;
	
	/* Clear SPIROV*/
	SPI2STATCLR &= ~0x40;
	/* Set CKP = 1, MSTEN = 1; */
        SPI2CON |= 0x60;
	
	/* Turn on SPI */
	SPI2CONSET = 0x8000;
	
	display_init();	
}

// END OF DISPLAY CODE!

void tostring(char str[], int num)
{
    int i, rem, len = 0, n;
    
    n = num;
    while (n != 0)
    {
        len++;
        n /= 10;
    }
    for (i = 0; i < len; i++)
    {
        rem = num % 10;
        num = num / 10;
        str[len - (i + 1)] = rem + '0';
    }
    str[len] = '\0';
}

void clearScrn(void){
    display_init();
    display_string(0, "");
    display_string(1, "");
    display_string(2, "");
    display_string(3, "");
    display_update();
}

void registerHighscore(int score) {
	
	/* 	Method will take score as argument and compare to highscore-array 
		to decide whether or not it qualifies the highscore */
	
	int i, j, temp;
	int n = sizeof(hiscore) / sizeof(int);
	
	if(hiScore[3] == 0){
		// Array is empty
		hiScore[3] = score;
	} else {
		hiscore[0] = score;
	}
	
	for(i = 0; i < n-1; i++) {
		for(j = 0; j < (n-1-i); j++) {
			if(hiscore[j] > hiscore[j+1]) {
					temp = hiscore[j];
					hiscore[j] = hiscore[j+1];
					hiscore[j+1] = temp;
			}
		}
	}
}

int showScore(){
    char str[10];
    tostring(str, score);

    display_init();
    display_string(0, "Score: ");
    display_string(1, str);
	display_update();
    
	if((PORTD & 0b000000100000) == 0b000000100000){
        return;
    }
    delay(100000000);
}
setScore(){
    hiScore[0]=10;
    hiScore[1]=11;
    hiScore[2]=2;
}
setHiScore(){
    int i=0;
    bool state=0;
    
	while(i<=3){

        if (state=0){
            if(hiScore[i]==0 || score > hiScore[i]){
                hiScore[i]=score;
				state=1;
            }
        }
        i++;
    }
    return 0;
}
    
int listHiScore(){
    display_init();
    char st0[10];
    char st1[10];
    char st2[10];
    char st3[10];
    display_string(0, "HighScore");
      tostring(st0, hiScore[3]);
        display_string(1, st0);
       tostring(st1, hiScore[2]);
        display_string(2, st1);
      tostring(st2, hiScore[1]);
        display_string(3, st2);
    display_update();
    if((PORTD & 0b000000100000) == 0b000000100000){
        return 0;
    }
    delay(100000000);
    return 0;

}
int speed(){
    display_init();
    display_string(0, "Choose Speed:");
    display_string(1, "1: Slow");
	display_string(2, "2: Med");
	display_string(3, "3: Fast");
    display_update();
    for(;;){
        if((PORTD & 0b000000100000) == 0b000000100000){
			// replace with appropriate delay-value for fast
            return 1000000000000000;
        }
        if((PORTD & 0b000001000000) == 0b000001000000){
            // replace with appropriate delay-value for med
			return 2000000000000000;
        }
        if((PORTD & 0b000010000000) == 0b000010000000){
            // replace with appropriate delay-value for slow
			return 300000000000000;
        }
    }
}

int menu(){
    display_init();
    display_string(0, "Choose Song:");
    display_string(1, "1: Wild world (Easy)");
    display_string(2, "2: The Robots (Medium)");
    display_string(3, "3: Can't Stop (Hard)");
    display_update();
    for(;;){
        if((PORTD & 0b0100000) == 0b0100000){
            return 1;
        }
        if((PORTD & 0b01000000) == 0b01000000){
            return 2;
        }
        if((PORTD & 0b010000000) == 0b010000000){
            return 3;
        }
    }
}
int main(void) {
    
	display_initiate();
    int song = menu();
    clearScrn();
    int spd = speed();
	//initPwm();
    clearScrn();
    if (song==1){
        gameInit(song1, spd);
    }if (song==2) {
        gameInit(song2, spd);
    }if(song==3){
        gameInit(song3, spd);
    }
    score = score/spd;
    showScore(score);
    //setHiScore();
    setScore();
    clearScrn();
    listHiScore();
    clearScrn();
    score=0;
    main();
	return 0;
}

void user_isr( void ) {
	if((IFS(0)&0x0100)==0x0100){
        IFSCLR(0) = 0x0100;
	}
}
